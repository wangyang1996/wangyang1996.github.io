---

layout:     post                    # 使用的布局（不需要改）
title:      k8s 基础学习            # 标题 
subtitle:   k8s                     #副标题
date:       2024-08-25             # 时间
author:     wangyang                     # 作者
header-img: img/post-bg-desk.jpg    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - k8s
---


k8s学习
=================
本篇文章记录k8s基础内容学习，命令和组件等

1.k8s命令
--------------------------

```shell
kubectl get nodes         //查看集群nodes信息
kubectl cluster-info      //查看集群信息
kubectl get pods -o wide  //查看pods信息
kubectl get deployments   //查看deployment应用信息
kubectl get rs            //查看rs信息
kubeadm token list        //查看token
kubectl get service       //查看端口映射信息
kubectl delete 资源类型 name  //删除某类资源类型
```

## 2.Controller控制器

### 2.1.Deployment

```shell
kubectl expose pod pod_name --type="NodePort" --port container_port     
//将容器container内的端口映射到当前节点node上的端口，方便外部访问容器服务
kubectl expose deployment deployment_name --type="ClusterIP" --port container_port     
//将容器container内的端口映射到集群IP上端口，方便经统一IP访问容器服务，实现负载均衡

docker exec -it container_name bash    //从对应node节点进入container容器

kubectl scale deployment deployment_name --replicas=num   //实现pod伸缩容 

kubectl set image deployment deployment_name app_name(deployment的app，即container)=image版本  
//滚动更新,更新过程中，pod逐个更新，逐个删除旧pod，rs资源会切换到新资源上
kubectl rollout undo deployment deployment_name   
//回滚版本,回滚过程中，pod逐个创建新pod,rs资源会切换到旧资源上

kubectl get pods --all-namespace  -o wide  //查看全部namespace下的pod
kubectl describe pod pod_name       //查看pod具体情况
kubectl describe 资源 资源名称。      //查看详细信息
systemctl status kubelet.service    //kubelet是唯一没有以容器形式运行的k8s组件
kubectl run deployment_name --image=xxx  --replicas=num   
//kubectl运行pod，创建过程：kubectl->apiserver->conroller manager->scheduler->kubelet

kubectl taint node k8s-master node-role.kubernetes.io/master-
//将master节点当作Node使用
kubectl taint node k8s-master node-role.kubernetes.io/master="":NoSchedule
//master节点不当Node使用

kubectl label node node_name key=value  
//为节点添加标签，可以在yml的pod规格spec.nodeSelector设置key: value，那么所有pod会部署到对应标签节点
kubectl get node --show-labels  //查看节点label
kubectl label node node_name key-
//删除标签，-即删除，删除需重新部署才会生效

```

nginx_pod_deployment.yml 

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
        app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        ports:
        - containerPort: 80
```



### 2.2.DaemonSet

```
每个node上最多只能运行一个副本
场景：集群每个节点存储Daemon、日志收集Daemon、监控Daemon
```

```
kubectl get daemonset -n kube-system     //会显示默认的kube-proxy
kubectl edit daemonset kube-proxy -n kube-system  //查看配置和运行状态,status
kubectl edit 资源类型 资源名称              //查看资源配置和运行状态，status

kubectl create namespace 名称             //创建命名空间
kubectl get namespace
```

node_exporter.yml

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-exporter-daemonset
  namespace: monitor
spec:
  selector:
    matchLabels:
        app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      hostNetwork: true
      containers:
      - name: node-exporter
        image: prom/node-exporter
        command:
        - /bin/node_exporter
        - --path.procfs
        - /host/proc
        - --path.sysfs
        - /host/sys
        - --collector.filesystem.ignored-mount-points
        - ^/(sys|proc|dev|host|etc)($|/)
        volumeMounts:
        - name: proc
          mountPath: /host/proc
        - name: sys
          mountPath: /host/sys
        - name: root
          mountPath: /rootfs
      volumes:
      - name: proc
        hostPath:
          path: /proc
      - name: sys
        hostPath:
          path: /sys
      - name: root
        hostPath:
          path: /
```



### 2.3.Job

```
容器按持续运行时间可分为两类：服务类容器和工作类容器
服务类容器持续提供服务
工作类容器则是一次性任务，比如批处理程序，完成后容器就退出
```

myjob.yml

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: myjob-job
spec:
  completions: 6              //执行总数
  parallelism: 2              //每次并行pod数量
  template:
    metadata:
      labels:
        app: myjob
    spec:
      containers:
      - name: hello
        image: busybox
        command: ["echo", "k8s job"]
      restartPolicy: Never
```

```
kubectl get job                //查看job执行情况
kubectl get pod                //查看job执行pod状态
kubectl logs pod_name          //查看job资源执行情况
```

```
Job资源pod如果执行失败，SUCCESSFUL的pod数量不为1的话，
根据配置的restartPolicy重启策略pod会重启直至成功pod为1；
restartPolicy: Never           //会出现多个执行失败pod
restartPolicy: OnFailure       //同一个pod一直重启，RESTARTS数量一直增加直到成功
```

### 2.4.CronJob

前置条件： Kube-apiserver支持batch/v1

```
cat /etc/kubernetes/manifests/kube-apiserver.yaml
systemctl restart kubelet.service        //如果修改重启生效
kubectl api-versions                     //确认是否支持
```

crontab.yml   

```yaml
kind: CronJob
metadata:
  name: cronjob
spec:
  schedule: "*/1 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            command: ["echo", "k8s job"]
          restartPolicy: OnFailure
```

```
kubectl get cronjob            //查看定时任务
kubectl get job                //查看每次任务执行情况
kubectl get pod                //查看每次任务执行pod
kubectl logs pod_name          //查看每次pod执行日志
kubectl delete -f cronjob.yml  //删除crontab资源
```

