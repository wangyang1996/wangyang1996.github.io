---
layout:     post                    # 使用的布局（不需要改）
title:      k8s权威指南学习-2            # 标题 
subtitle:   kubernetes                     #副标题
date:       2025-02-10             # 时间
author:     wangyang                     # 作者
header-img: img/post-bg-coffee.jpeg    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - k8s
---

# Service

### Service定义

通过创建service，可以为一组具有相同功能的容器应用提供一个统一的入口地址，并且将请求负载分发到后端的各个容器应用上。

```
# webapp-deployment.yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      - name: webapp
        image: kubeguide/tomcat-app:v1
        ports:
        - containerPort: 8080


# webapp-service.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: webapp
spec:
  ports:
  - protocol: TCP
    port: 8080          //servcie服务监听端口号
    targetPort: 8080    //后端pod服务容器端口号
  selector:             //匹配相关pod标签
    app: webapp
```

Service实现微服务架构相关核心功能：全自动的服务注册、服务发现、服务负载均衡

命令创建Service:  kubectl expose deployment <deployment_name>

```
service对应后端由pod的IP和容器端口号组成，在k8s系统中叫Endpoint。
kubectl describe service <service_name>      查看service详细信息
kubectl get endpoints             查看endpoints对象
```

Service还可以以DNS域名方式存在，域名表示方法为：

```
<service_name>.<namespace>.svc.<cluster_domain>
service名称.命名空间.svc.k8s集群设置的域名后缀
```

从service服务IP到后端pod的负载均衡由每个node上的kube-proxy负责实现



### Service会话保持机制

```
支持通过设置service.spec.sessionAffinity: ClientIP 实现基于客户端IP的会话保持机制，请求会转发到相同的后端pod上
spec:
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: xxx      //设置会话保持最长时间
```



### Service的多端口设置

一个容器应用可以提供多个端口的服务，在service定义中也可以相应地设置多个端口号。

或者同一个端口号使用协议不同，也需设置多个端口号来提供不同的服务

```
spec
  ......
  ports:
  - name: dns
    port: 53
    targetPort: 53
    protocol: UDP
  - name: dns-tcp   //设置端口号区分
    port: 53
    targetPort: 53
    protocol: TCP    
```



### 将外部服务定义为service

Service还可以抽象定义任意其他服务，可以将k8s集群外的已知服务定义为k8s内的一个Service，供集群内的其他应用访问，场景：

已部署的集群外服务，数据库、缓存

其他k8s集群的某个服务

针对这种情况，设置Service不需要设置label selector（无后端pod存在），但需要定义Service关联的Endpoint资源对象，设置外部服务IP地址和端口号

```
---
kind: Service
apiVersion: v1
metadata:
  name: my-service
spec:
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80

---
kind: Endpoints    //请求将路由到自定义后端的Endpoint上
apiVersion: v1
metadata:
  name: my-service
subsets:
- addresses:
  - ip: 1.2.3.4
  ports:
  - port: 80
```

